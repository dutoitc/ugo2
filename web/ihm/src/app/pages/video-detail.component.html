<a routerLink="/" class="button back">‚Üê Retour</a>

<!-- EN-T√äTE + DESCRIPTION (largeur = tableau) -->
<div class="card wide block" *ngIf="data() as d">
  <h2>{{ d.video.title || '(sans titre)' }}</h2>
  <div class="meta">
    publi√©: {{ toLocal(d.video.published_at) }}
  </div>
  <p class="desc" *ngIf="d.video.description">{{ d.video.description }}</p>
</div>

<!-- KPIs ROLLUP (largeur = tableau) -->
<div class="card kpi wide block" *ngIf="data() as d2">
  <div><b>Vues (total):</b> {{ fmtInt(rollViewsSum()) }}</div>
  <div><b>Likes:</b> {{ fmtInt(rollLikes()) }}</div>
  <div><b>Commentaires:</b> {{ fmtInt(rollComments()) }}</div>
  <div><b>Partages:</b> {{ fmtInt(rollShares()) }}</div>
  <div><b>Dur√©e des vues, total:</b> {{ fmtHMS(rollWatchSeconds()) }}</div>
  <div><b>Taux d‚Äôengagement:</b> {{ rollEngRate() }}</div>
</div>

<!-- Graphe GLOBAL (une seule s√©rie) -->
<div class="card wide block" *ngIf="data()">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Vues dans le temps (global)</h3>
    <div>
      <button class="small" (click)="setGran('hour')" [class.active]="gran==='hour'">1h</button>
      <button class="small" (click)="setGran('day')"  [class.active]="gran==='day'">1d</button>
    </div>
  </div>

  <div id="chart" style="height:320px; width:100%; margin-top:10px;"></div>
  <div class="small-note">
    Les donn√©es affich√©es sont agr√©g√©es selon la granulom√©trie choisie.
    Endpoint prioritaire : <code>/api/v1/video/{{ '{' }}id{{ '}' }}/timeseries</code>.
  </div>
</div>

<!-- Graphes PAR PLATEFORME -->
<div class="card wide block" *ngIf="platforms().length">
  <h3>Vues par plateforme</h3>
  <div class="platform-charts">
    <div class="platform-chart" *ngFor="let p of platforms()">
      <div class="chart-header">{{ p }}</div>
      <div [id]="'chart-platform-'+p" style="height:280px; width:100%; margin-top:6px;"></div>
    </div>
  </div>
  <div class="small-note">Chaque graphe affiche une seule plateforme.</div>
</div>

<!-- Cartes par source (placeholder simple) -->
<div class="card wide block" *ngIf="data() as d">
  <h3>Sources / Localisation</h3>
  <div class="sources-row">
    <div class="source-card" *ngFor="let s of bySource()">
      <div class="src-title">{{ s.platform }}</div>
      <div class="src-count">{{ fmtInt(s.views) }} vues</div>
      <!-- mini sparklines via echarts small instances -->
      <div class="spark" [attr.data-src]="s.platform" [id]="'spark-'+s.platform"></div>
      <div class="src-meta">Dernier snapshot: {{ toLocal(s.last_snapshot_at) }}</div>
    </div>
  </div>
  <div class="small-note">Mini-cartes / sparklines. Pour une carte g√©ographique compl√®te il faut enrichir la source avec lat/lon c√¥t√© API.</div>
</div>

<!-- SOURCES / LATEST (NE PAS MODIFIER) -->
<table class="table wide table-center block" *ngIf="latestRows().length">
  <thead>
  <tr>
    <th class="col-title left">Plateforme / Lien</th>
    <th class="col-small">ID</th>
    <th class="col-small">Snapshot</th>
    <th class="col-small">Vues</th>
    <th class="col-small">Likes</th>
    <th class="col-small">Commentaires</th>
    <th class="col-small">Partages</th>
    <th class="col-small">Dur√©e de vue moyenne</th>
    <th class="col-small">Dur√©e de vue totale</th>
    <th class="col-small">Dur√©e de vue √©quivalente</th>
    <th class="col-small">Taux d'engagement</th>
  </tr>
  </thead>
  <tbody>
  <tr *ngFor="let r of latestRows()">
    <td class="col-title left">
      {{ r.src.platform }}
      <span *ngIf="r.l?.url">
        ‚Ä¢ <a [href]="r.l?.url" target="_blank" rel="noopener">ouvrir</a>
      </span>
    </td>
    <td class="col-small">{{ r.src.platform_video_id || r.l?.platform_video_id || '‚Äî' }}</td>
    <td class="col-small">{{ toLocal(r.l?.snapshot_at) }}</td>
    <td class="col-small">{{ fmtInt(r.l?.views_native) }}</td>
    <td class="col-small">{{ fmtInt(r.l?.likes) }}</td>
    <td class="col-small">{{ fmtInt(r.l?.comments) }}</td>
    <td class="col-small">{{ fmtInt(r.l?.shares) }}</td>
    <td class="col-small">{{ fmtHMS(r.l?.avg_watch_seconds) }}</td>
    <td class="col-small">{{ fmtHMS(r.l?.total_watch_seconds) }}</td>
    <td class="col-small">{{ fmtInt(r.l?.watch_equivalent) }}</td>
    <td class="col-small">{{ engRateForRow(r) }}</td>
  </tr>
  </tbody>
</table>

<!-- R√âACTIONS (largeur = tableau) -->
<div class="card wide block" *ngIf="latestRows().length">
  <h3>R√©actions (d√©tail)</h3>
  <ul class="raw-list">
    <li *ngFor="let r of latestRows()">
      <b>{{ r.src.platform }}</b> :<br/>
      {{ fmtInt(r.l?.reactions_like) }} üëç J'aime<br/>
      {{ fmtInt(r.l?.reactions_love) }} ‚ù§Ô∏è J'adore<br/>
      {{ fmtInt(r.l?.reactions_wow) }} üòÆ Wow<br/>
      {{ fmtInt(r.l?.reactions_haha) }} üòÇ Haha<br/>
      {{ fmtInt(r.l?.reactions_sad) }} üò¢ Triste<br/>
      {{ fmtInt(r.l?.reactions_angry) }} üò° Furieux
    </li>
  </ul>
</div>
