<a routerLink="/" class="button back">← Retour</a>

<div class="card wide block" *ngIf="data() as d">
  <h2>{{ d.video.title || '(sans titre)' }}</h2>
  <div class="meta">publié: {{ toLocal(d.video.published_at) }}</div>
  <p class="desc" *ngIf="d.video.description">{{ d.video.description }}</p>
</div>

<div class="card kpi wide block" *ngIf="data() as d2">
  <div><b>Vues (total):</b> {{ fmtInt(rollViewsSum()) }}</div>
  <div><b>Likes:</b> {{ fmtInt(rollLikes()) }}</div>
  <div><b>Commentaires:</b> {{ fmtInt(rollComments()) }}</div>
  <div><b>Partages:</b> {{ fmtInt(rollShares()) }}</div>
  <div><b>Durée des vues, total:</b> {{ fmtHMS(rollWatchEqSeconds()) }}</div>
  <div><b>Taux d’engagement:</b> {{ rollEngRate() }}</div>
</div>

<div class="card wide block">
  <h3>Évolution des vues</h3>
  <div id="chart-global" style="height:240px;width:100%"></div>
</div>

<div class="card wide block" *ngIf="latestRows().length">
  <h3>Dernières métriques par source</h3>
  <table class="table">
    <thead>
    <tr>
      <th class="col-title left">Source</th>
      <th class="col-small">ID</th>
      <th class="col-small">Snapshot</th>
      <th class="col-small">Vues</th>
      <th class="col-small">Likes</th>
      <th class="col-small">Com.</th>
      <th class="col-small">Partages</th>
      <th class="col-small">Watch eq.</th>
      <th class="col-small">Eng. rate</th>
      <th class="col-spark">Trend</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let r of latestRows(); trackBy: trackByPlatform">
      <td class="col-title left">
        {{ r.src.platform }}
        <span *ngIf="r.l?.url"> • <a [href]="normalizeUrl(r.l?.url, r.src.platform)" target="_blank" rel="noopener">ouvrir</a></span>
      </td>
      <td class="col-small">{{ r.src.platform_video_id || r.l?.platform_video_id || '—' }}</td>
      <td class="col-small">{{ toLocal(r.l?.snapshot_at) }}</td>
      <td class="col-small">{{ fmtInt(r.l?.views_native) }}</td>
      <td class="col-small">{{ fmtInt(r.l?.likes) }}</td>
      <td class="col-small">{{ fmtInt(r.l?.comments) }}</td>
      <td class="col-small">{{ fmtInt(r.l?.shares) }}</td>
      <td class="col-small">{{ fmtHMS(r.l?.watch_equivalent) }}</td>
      <td class="col-small">{{ engRateForRow(r) }}</td>
      <td class="col-spark">
        <div [id]="'spark-' + r.src.platform.toUpperCase()" style="height:28px;width:160px"></div>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div class="card wide block" id="charts-by-platform" *ngIf="latestRows().length">
  <h3>Par plateforme</h3>
  <div class="grid grid-2">
    <div *ngFor="let r of latestRows(); trackBy: trackByPlatform" class="pane">
      <h4>{{ r.src.platform }}</h4>
      <div [id]="'chart-' + r.src.platform.toUpperCase()" style="height:180px;width:100%"></div>
    </div>
  </div>
</div>

<div class="card wide block" *ngIf="hasAnyReactions()">
  <h3>Réactions (détail)</h3>
  <ul class="raw-list">
    <li *ngFor="let r of reactionsRows(); trackBy: trackByPlatform">
      <b>{{ r.src.platform }}</b> :
      <ng-container *ngIf="showIfPos(r.l?.reactions_like)"><br/>{{ fmtInt(r.l?.reactions_like) }} 👍 J'aime</ng-container>
      <ng-container *ngIf="showIfPos(r.l?.reactions_love)"><br/>{{ fmtInt(r.l?.reactions_love) }} ❤️ J'adore</ng-container>
      <ng-container *ngIf="showIfPos(r.l?.reactions_wow)"><br/>{{ fmtInt(r.l?.reactions_wow) }} 😮 Wow</ng-container>
      <ng-container *ngIf="showIfPos(r.l?.reactions_haha)"><br/>{{ fmtInt(r.l?.reactions_haha) }} 😂 Haha</ng-container>
      <ng-container *ngIf="showIfPos(r.l?.reactions_sad)"><br/>{{ fmtInt(r.l?.reactions_sad) }} 😢 Triste</ng-container>
      <ng-container *ngIf="showIfPos(r.l?.reactions_angry)"><br/>{{ fmtInt(r.l?.reactions_angry) }} 😡 Furieux</ng-container>
    </li>
  </ul>
</div>
